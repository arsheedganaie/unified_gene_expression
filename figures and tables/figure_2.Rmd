---
title: "Figure 2"
output: html_notebook
---

```{r}
library(Rtsne)
library(ggplot2)
library(tidyverse)
library(superheat)
source('~/git/scripts/theme_Publication.R')
# https://github.com/stephaniehicks/qsmooth
load('~/git/unified_gene_expression/data/lengthScaledTPM_all_2017.Rdata')
load('~/git/unified_gene_expression/data/lengthScaledTPM_processed_01_27_2017.Rdata')
source('~/git/unified_gene_expression/scripts/parse_sample_attribute.R')
source('~/git/scripts/theme_Publication.R')
```

Plot eye-only clustering
```{r, fig.width=3, fig.height=3}
set.seed(23235)
eye_samples <- core_tight %>% 
  filter(sample_accession %in% colnames(lengthScaledTPM_qsmooth_highExp_remove_lowGenes)) %>% 
  filter(!Tissue %in% 'ENCODE Cell Line') %>% 
  filter(study_accession!='SRP012682') %>% 
  filter(!sample_accession %in% c('SRS523795','SRS360124','SRS360123')) %>% 
  .[['sample_accession']]

eye_TPM <- lengthScaledTPM_qsmooth_highExp_remove_lowGenes[,eye_samples]
perp=25
tsne_out <- Rtsne(as.matrix(log2(t(eye_TPM)+1)),perplexity = perp, check_duplicates = FALSE, theta=0.0)
tsne_plot <- data.frame(tsne_out$Y)
tsne_plot$sample_accession <- colnames(eye_TPM)

tsne_plot %>% left_join(.,core_tight)  %>% 
  mutate(Origin=factor(Origin, levels=c('Fetal Tissue', 'Adult Tissue', 'Cell Line'))) %>% 
  ggplot(.,aes(x=X1,y=X2,colour=Tissue,shape=Origin)) + 
  geom_point(size=4, alpha=0.8) + scale_shape_manual(values=c(0:20,35:50)) +
  ggtitle(paste0('Eye tissue t-sne')) +
  theme_Publication() + guides(colour=guide_legend(nrow=2), shape=guide_legend(nrow=2))
```

Plot pan-human tissue expression
```{r, fig.width=4, fig.height=4.5}
set.seed(23235)
eye_and_gtex_samples <- core_tight %>% 
  filter(sample_accession %in% colnames(lengthScaledTPM_qsmooth_highExp_remove_lowGenes)) %>% 
  filter(!Tissue %in% 'ENCODE Cell Line') %>% 
  filter(!sample_accession %in% c('SRS523795','SRS360124','SRS360123')) %>% 
  .[['sample_accession']]

eye_and_gtex_TPM <- lengthScaledTPM_qsmooth_highExp_remove_lowGenes[,eye_and_gtex_samples]
perp=35
tsne_out <- Rtsne(as.matrix(log2(t(eye_and_gtex_TPM)+1)),perplexity = perp, check_duplicates = FALSE, theta=0.0)
tsne_plot <- data.frame(tsne_out$Y)
tsne_plot$sample_accession <- colnames(eye_and_gtex_TPM)

tsne_plot %>% left_join(.,core_tight)  %>% 
  mutate(Study = study_accession) %>% 
  ggplot(.,aes(x=X1,y=X2,colour=Tissue,shape=Tissue,alpha=0.6)) + 
  geom_point(size=4, alpha=0.8) + scale_shape_manual(values=c(0:20,35:50)) +
  ggtitle(paste0('Pan-human tissue t-sne')) +
  theme_Publication() + guides(colour=guide_legend(nrow=6), shape=guide_legend(nrow=6))
```

Heatmap of t-sne distances for pan-tissue. Aggregated at the tissue level
```{r ,fig.width=4, fig.height=4}

mean_coord <- tsne_plot %>% 
  left_join(.,core_tight) %>% 
  group_by(Tissue) %>% 
  summarise(X1=mean(X1),X2=mean(X2)) %>% 
  data.frame()

distances <- as.matrix(dist(mean_coord[,2:3])) %>% data.frame() 
colnames(distances) <- mean_coord[,1]                     
row.names(distances) <- mean_coord[,1]
superheat(distances, 
          heat.pal = c('#386cb0','white'),
          col.dendrogram = T,
          pretty.order.rows = T, 
          pretty.order.cols = T,
          bottom.label.text.angle = 90,
          bottom.label.text.size = 4, 
          left.label.text.size = 4)
```
```{r, fig.width=6, fig.height=8}
dist_perplexity = list()

for (n in seq(20,40)) {
  set.seed(935489)
  tsne_out <- Rtsne(as.matrix(log2(t(eye_and_gtex_TPM)+1)),perplexity = n, check_duplicates = FALSE, theta=0.0 )
  # Perplexity is a measure for information that is defined as 2 to the power of the Shannon entropy. The perplexity of a fair die with k sides is equal to k. In t-SNE, the perplexity may be viewed as a knob that sets the number of effective nearest neighbors. It is comparable with the number of nearest neighbors k that is employed in many manifold learners.
  tsne_plot <- data.frame(tsne_out$Y)
  tsne_plot$sample_accession <- colnames(eye_and_gtex_TPM)
  
  mean_coord <- tsne_plot %>% 
    left_join(.,core_tight) %>% 
    group_by(Tissue) %>% 
    summarise(X1=mean(X1),X2=mean(X2)) %>% 
    data.frame()

  distances <- as.matrix(dist(mean_coord[,2:3])) %>% data.frame() 
  colnames(distances) <- mean_coord[,1]                     
  row.names(distances) <- mean_coord[,1]
  
  mean_coord$perplexity <- n
  dist_perplexity[[n]]<-mean_coord
}
many_dist <- do.call(rbind, dist_perplexity)

multi_perplexity <- many_dist %>% group_by(Tissue) %>% summarise(X1=mean(X1),X2=mean(X2)) %>% data.frame()

distances <- as.matrix(dist(multi_perplexity[,2:3])) %>% data.frame() 
colnames(distances) <- multi_perplexity[,1]                     
row.names(distances) <- multi_perplexity[,1]
superheat(distances, 
          heat.pal = c('#386cb0','white'),
          col.dendrogram = T,
          pretty.order.rows = T, 
          pretty.order.cols = T,
          bottom.label.text.angle = 90,
          bottom.label.text.size = 4, 
          left.label.text.size = 4)
```