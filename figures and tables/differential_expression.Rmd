---
title: "Figure 3"
output:
  html_notebook: default
  word_document: default
---
```{r,message = FALSE}
library(broom)
library(UpSetR)
library(tidyverse)
library(limma)
library(DT)
library(ReporteRs)
load('~/git/unified_gene_expression/data/big_six_DE_correct.Rdata')
load('~/git/unified_gene_expression/data/limma_voom_DE_all_by_all.Rdata')
source('~/git/unified_gene_expression/scripts/GO_enrichment.R')
source('~/git/unified_gene_expression/scripts/GO_term_finder.R')
# for GO enrichement
background_genes <- topTable(big_six[[1]], number=30000) %>% rownames_to_column('Gene') %>% dplyr::select(Gene)
options("ReporteRs-fontsize"=8, "ReporteRs-default-font"="Monaco")
```

Overall counts up and down for the six tests
```{r, message = FALSE}
test1_summary <- summary(decideTests(big_six[[1]], lfc = 1, p.value = 0.01, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '1')
test2_summary <- summary(decideTests(big_six[[2]], lfc = 1, p.value = 0.01, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '2')
test3_summary <- summary(decideTests(big_six[[3]], lfc = 1, p.value = 0.01, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '3')
test4_summary <- summary(decideTests(big_six[[4]], lfc = 1, p.value = 0.01, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '4')
test5_summary <- summary(decideTests(big_six[[5]], lfc = 1, p.value = 0.01, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '5')
test6_summary <- summary(decideTests(big_six[[6]], lfc = 1, p.value = 0.01, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '6')

test_summaries <- rbind(test1_summary,test2_summary,test3_summary,test4_summary,test5_summary,test6_summary)
colnames(test_summaries) <- c('LogFC','Comparison','Count','Comparison Set')

test_summaries <- test_summaries %>% 
  filter(LogFC!=0) %>% 
  dplyr::select(-`Comparison Set`) %>% 
  spread(Comparison, Count) %>% t() %>% 
  data.frame() %>% 
  rownames_to_column('Comparisons') %>% 
  dplyr::slice(-1) %>% 
  separate(Comparisons, c('Comparison','Base'), sep='_vs_') %>% 
  mutate(Comparison=gsub('\\.',' (',Comparison), Comparison=gsub('$',')', Comparison), Comparison=gsub('cell',' cell', Comparison)) %>% 
  mutate(Base=gsub('\\.',' (',Base), Base=gsub('$',')', Base), Base=gsub('cell',' cell', Base))

colnames(test_summaries)<- c('Comparison','Reference', 'LogFC < -1', 'LogFC > 1')
```

Format table 
http://davidgohel.github.io/ReporteRs/articles/flextable_examples.html
```{r}
no_border = borderProperties( width = 0 )
big_border = borderProperties( width = 2 )
std_border = borderProperties( width = 1 )
    
the_table <- test_summaries %>% 
  mutate(Test=c('A','A','A','B','B','B','C','C','C','D','E','F','F','F')) %>% 
  mutate(Comparison = paste(Comparison, Reference, sep = ' vs ')) %>% 
  dplyr::select(Test, Comparison, `LogFC < -1`, `LogFC > 1`)

flex_table <- the_table %>% FlexTable(body.cell.props = cellProperties( padding = 2 ), 
                        header.par.props = parProperties(text.align = "center" ), 
                        body.par.props = parProperties(text.align = 'left'),
                        header.columns = FALSE) %>% 
  spanFlexTableRows(.,j="Test",runs=as.character(the_table$Test)) %>%
  addHeaderRow(value = c("", "Log Fold Change"), colspan = c( 2, 2 ) ) %>% 
  addHeaderRow(value = c('Test', 'Comparison', '< -1', '> 1')) %>% 
  setFlexTableWidths(widths = c(1,5, 1, 1) )  %>% 
  setFlexTableBorders(footer = TRUE,
                      inner.vertical = no_border, inner.horizontal = std_border,
                      outer.vertical = no_border, outer.horizontal = big_border )

flex_table[2,1:2, to="header", side = "top"] = no_border
flex_table
#doc = docx()
#doc = addFlexTable(doc, flex_table)
#writeDoc(doc,file='~/Desktop/table class.docx')
```

Function to pull different sets out
```{r, message = FALSE}
set_maker <- function(a,b,c){
  a_set <- setdiff(a,c(b,c))
  b_set <- setdiff(b,c(a,c))
  c_set <- setdiff(c,c(a,b))
  abc <- Reduce(intersect,list(a,b,c))
  ab <- setdiff(intersect(a,b),c)
  ac <- setdiff(intersect(a,c),b)
  bc <- setdiff(intersect(b,c),a)
  list(a=a_set,b=b_set,c=c_set,ab=ab,ac=ac,bc=bc,abc=abc)
}
```

Function to return gene list that are abs(logFC) > 1 and adj.P.Val < 0.05 for the different contrasts
```{r, messag= FALSE}
# all sig
contrast_gene_lists <- function(limma_data){
  vector_of_comparisons <- colnames(limma_data)
  print(vector_of_comparisons)
  out_list <- list()
  for (i in 1:length(vector_of_comparisons)){
    stats <-  topTable(limma_data, coef=i, number = 30000, adjust.method = 'fdr', p.value = 0.05)
    if(nrow(stats)==0){
      out_list[vector_of_comparisons[i]] <- list('')
      next}
    stats_cut_down <- stats[abs(stats[,'logFC']) > 1,]
    out_list[vector_of_comparisons[i]] <- list(row.names(stats_cut_down))
    }
  out_list
}
# just up vs 'control' (right side of contrast)
contrast_UPgene_lists <- function(limma_data){
  vector_of_comparisons <- colnames(limma_data)
  out_list <- list()
  for (i in 1:length(vector_of_comparisons)){
    stats <-  topTable(limma_data, coef=i, number = 30000, adjust.method = 'fdr', p.value = 0.05)
    if(nrow(stats)==0){
      out_list[vector_of_comparisons[i]] <- list('')
      next}
    stats_cut_down <- stats[stats[,'logFC'] > 1,]
    out_list[vector_of_comparisons[i]] <- list(row.names(stats_cut_down))
    }
  out_list
}
# just down vs 'control' 
contrast_DOWNgene_lists <- function(limma_data){
  vector_of_comparisons <- colnames(limma_data)
  out_list <- list()
  for (i in 1:length(vector_of_comparisons)){
    stats <-  topTable(limma_data, coef=i, number = 30000, adjust.method = 'fdr', p.value = 0.05)
    if(nrow(stats)==0){
      out_list[vector_of_comparisons[i]] <- list('')
      next}
    stats_cut_down <- stats[stats[,'logFC'] < -1,]
    out_list[vector_of_comparisons[i]] <- list(row.names(stats_cut_down))
    }
  out_list
}
```



```{r}
#GO printer
go_printer <- function(go_frame, num_to_print, title){
  out <- go_frame %>% arrange(as.numeric(`P value`)) %>% 
    head(n=num_to_print)  %>%  FlexTable(body.cell.props = cellProperties( padding = 2 ), 
                        header.par.props = parProperties(text.align = "left" ), 
                        body.par.props = parProperties(text.align = 'left'), header.columns = FALSE) %>%
    addHeaderRow(value = c(title), colspan = c(8), par.properties = parProperties(text.align='left')) %>% 
    addHeaderRow(value = colnames(go_frame)) %>% 
    setFlexTableWidths(widths = c(1, 1.4, 1.2, 1, 0.5, 0.7, 0.7, 6) )  %>% 
    setFlexTableBorders(inner.vertical = no_border, inner.horizontal = no_border,
                      outer.vertical = no_border, outer.horizontal = big_border )
  print(out)
}

# alt go printer to try and make a bit more sense out of the 80 bajillion results we get for retina vs rpe
go_printer2 <- function(go_frame, num_to_print, title){
  out <- go_frame %>% filter(as.numeric(`P value (FDR)`) < 0.05, as.numeric(Count) > 9, `Odds Ratio` > 4) %>% 
    head(n=num_to_print) %>% 
    FlexTable(body.cell.props = cellProperties( padding = 2 ), 
                        header.par.props = parProperties(text.align = "left" ), 
                        body.par.props = parProperties(text.align = 'left'), header.columns = FALSE) %>%
    addHeaderRow(value = c(title), colspan = c(8), par.properties = parProperties(text.align='left')) %>% 
    addHeaderRow(value = colnames(go_frame)) %>% 
    setFlexTableWidths(widths = c(1, 1.4, 1.2, 1, 0.5, 0.7, 0.7, 6) )  %>% 
    setFlexTableBorders(inner.vertical = no_border, inner.horizontal = no_border,
                      outer.vertical = no_border, outer.horizontal = big_border )
  print(out)
}
```

All GO comparison runner. Takes in the output from the set generator and makes does GO enrichment for all 6 unique categories (a, b, c, ab, bc, abc)
```{r, message = FALSE}
all_go_tester <- function(limma_data, test_name){
  column_classes <- rep(x='character',12)
  column_names <- c("GO BP ID","P value","P value (FDR)","Odds Ratio","Expected Count","Count","Size","Term","Test","Set","Direction", "Contrasts")
  empty_frame <- read.table(text='', colClasses = column_classes, col.names = column_names)
  contrasts <- colnames(limma_data) #example: big_six[[1]]
  all_go_terms = empty_frame
  print('Up')
  up_expressed_genes <- contrast_UPgene_lists(limma_data)
  up_expressed_sets <- set_maker(up_expressed_genes[[contrasts[1]]],
                  up_expressed_genes[[contrasts[2]]],
                  up_expressed_genes[[contrasts[3]]])
  for (i in names(up_expressed_sets)){
    if (length(up_expressed_sets[[i]])<6){
      print(paste(i, 'has less than 6 genes in it, skipping GO enrichment'))
    } 
    else {
      print(i)
      go_run <- GO_enrichment(up_expressed_sets[[i]], background_genes ,'BP')
      go_run <- go_run %>% data.frame() %>% mutate(Test=test_name, Set=i,Direction='Up',Contrasts=paste(contrasts, collapse=','))
      all_go_terms <- rbind(all_go_terms, go_run)
    }
  }
  print('Down')
  down_expressed_genes <- contrast_DOWNgene_lists(limma_data)
  down_expressed_sets <- set_maker(down_expressed_genes[[contrasts[1]]],
                  down_expressed_genes[[contrasts[2]]],
                  down_expressed_genes[[contrasts[3]]])
  for (i in names(down_expressed_sets)){
    if (length(down_expressed_sets[[i]])<6){
      print(paste(i, 'has less than 6 genes in it, skipping GO enrichment'))
    } 
    else {
      print(i)
      go_run <- GO_enrichment(down_expressed_sets[[i]], background_genes ,'BP')
      go_run <- go_run %>% data.frame() %>% mutate(Test=test_name, Set=i,Direction='Down',Contrasts=paste(contrasts, collapse=','))
      all_go_terms <- rbind(all_go_terms, go_run)
    }
  }
colnames(all_go_terms) <- c("GO BP ID","P value","P value (FDR)","Odds Ratio","Expected Count","Count","Size","Term","Test","Set","Direction", "Contrasts")
all_go_terms
}
```

Six DE tests:

1. Cornea vs Retina vs RPE (all adult)
2. ESC vs RPE vs Retina (all Stem cell lines, non immortalized)
3. Adult RPE vs Fetal RPE vs Cell Line RPE
4. immortalized RPE vs Stem Cell Line RPE
5. Adult Retina vs Stem Cell Line Retina
6. Adult Cornea vs Fetal Cornea vs Cell Line Cornea


# 1. Cornea vs Retina vs RPE (all adult)
```{r, message = FALSE, fig.width=3, fig.height=2.5}

colnames(big_six[[1]])

test1_contrast_genes <- contrast_gene_lists(big_six[[1]])
# test1_comps <- list('Cornea vs Retina' = test1_contrast_genes$Cornea.adult_vs_Retina.adult, 
#                    'Cornea vs RPE' = test1_contrast_genes$Cornea.adult_vs_RPE.adult, 
#                    'Retina vs RPE' = test1_contrast_genes$Retina.adult_vs_RPE.adult)
# upset(fromList(test1_comps),mainbar.y.max = 3250, keep.order = T)


test1_contrast_genes <- contrast_UPgene_lists(big_six[[1]])
test1_comps <- list('Cornea vs Retina' = test1_contrast_genes$Cornea.adult_vs_Retina.adult, 
                   'Cornea vs RPE' = test1_contrast_genes$Cornea.adult_vs_RPE.adult, 
                   'Retina vs RPE' = test1_contrast_genes$Retina.adult_vs_RPE.adult)
upset(fromList(test1_comps),sets = rev(names(test1_comps)), mainbar.y.max = 3000, keep.order = T, sets.bar.color = '#3eb9c4', matrix.color = '#3eb9c4', main.bar.color = '#3eb9c4', set_size.angles = 45)


test1_contrast_genes <- contrast_DOWNgene_lists(big_six[[1]])
test1_comps <- list('Cornea vs Retina' = test1_contrast_genes$Cornea.adult_vs_Retina.adult, 
                   'Cornea vs RPE' = test1_contrast_genes$Cornea.adult_vs_RPE.adult, 
                   'Retina vs RPE' = test1_contrast_genes$Retina.adult_vs_RPE.adult)
upset(fromList(test1_comps),sets = rev(names(test1_comps)),mainbar.y.max = 3000, keep.order = T, sets.bar.color = '#ef6d62', matrix.color = '#ef6d62', main.bar.color = '#ef6d62', set_size.angles = 45)
```

GO enrichment. Retina against RPE
```{r, message = FALSE, fig.width=3, fig.height=3}
testA_go_all_sets <- all_go_tester(big_six[[1]],'Test A')

go_printer(testA_go_all_sets %>% filter(Test=='Test A',Set=='b',Direction=='Down') %>%  dplyr::select(`GO BP ID`:Term),15, 'Test A - Set B Down')
# 
# 
# # Retina vs RPE unique, up (RPE << retina for gene expression)
# test1_contrast_genes <- contrast_UPgene_lists(big_six[[1]])
# sets <- set_maker(test1_contrast_genes$Cornea.adult_vs_Retina.adult,
#                   test1_contrast_genes$Cornea.adult_vs_RPE.adult,
#                   test1_contrast_genes$Retina.adult_vs_RPE.adult)
# length(sets$c)
# retina_rpe_GO_up <- GO_enrichment(sets$c, background_genes ,'BP')
# 
# retina_rpe_GO_genes_up <- sets$c
# nrow(retina_rpe_GO_up %>% filter(as.numeric(`P value (FDR)`)<0.05))
# go_printer2(retina_rpe_GO_up,8,'Retina > RPE')
# 
# # Retina vs RPE unique, down (retina << RPE)
# test1_contrast_genes <- contrast_DOWNgene_lists(big_six[[1]])
# sets <- set_maker(test1_contrast_genes$Cornea.adult_vs_Retina.adult,
#                   test1_contrast_genes$Cornea.adult_vs_RPE.adult,
#                   test1_contrast_genes$Retina.adult_vs_RPE.adult)
# length(sets$c)
# retina_rpe_GO_down <- GO_enrichment(sets$c, background_genes ,'BP')
# nrow(retina_rpe_GO_down %>% filter(as.numeric(`P value (FDR)`)<0.05))
# go_printer2(retina_rpe_GO_down,8,'Retina < RPE')
```

Go enrichment. Cornea against Retina/RPE
```{r, message = FALSE, fig.width=3, fig.height=2.5}
# # cornea vs RPE and retina (RPE and retina << cornea)
# test1_contrast_genes <- contrast_UPgene_lists(big_six[[1]])
# sets <- set_maker(test1_contrast_genes$Cornea.adult_vs_Retina.adult,
#                   test1_contrast_genes$Cornea.adult_vs_RPE.adult,
#                   test1_contrast_genes$Retina.adult_vs_RPE.adult)
# length(sets$ab)
# cornea_vs_retina_rpe_GO_up <- GO_enrichment(sets$ab, background_genes ,'BP')
# nrow(cornea_vs_retina_rpe_GO_up %>% filter(as.numeric(`P value (FDR)`)<0.05))
# go_printer(cornea_vs_retina_rpe_GO_up,8, 'Cornea > RPE and Retina')
# 
# 
# # cornea vs RPE and retina (RPE and retina >> cornea)
# test1_contrast_genes <- contrast_DOWNgene_lists(big_six[[1]])
# sets <- set_maker(test1_contrast_genes$Cornea.adult_vs_Retina.adult,
#                   test1_contrast_genes$Cornea.adult_vs_RPE.adult,
#                   test1_contrast_genes$Retina.adult_vs_RPE.adult)
# length(sets$ab)
# cornea_vs_retina_rpe_GO_down <- GO_enrichment(sets$ab, background_genes ,'BP')
# nrow(cornea_vs_retina_rpe_GO_down %>% filter(as.numeric(`P value (FDR)`)<0.05))
# go_printer(cornea_vs_retina_rpe_GO_down,8, 'Cornea < RPE and Retina')

```

# 2. ESC vs RPE vs Retina (all Stem cell lines, non immortalized)
```{r, message = FALSE, fig.width=3, fig.height=2.5}
colnames(big_six[[2]])
# test2_contrast_genes <- contrast_gene_lists(big_six[[2]])
# test2_comps <- list('ESC vs Retina (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_Retina.stemcell, 
#                    'ESC vs RPE (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_RPE.stemcell, 
#                    'Retina (stem cell) vs RPE (stem cell)' = test2_contrast_genes$Retina.stemcell_vs_RPE.stemcell)
# upset(fromList(test2_comps), keep.order = T, mainbar.y.max = 3000)

test2_contrast_genes <- contrast_UPgene_lists(big_six[[2]])
test2_comps <- list('ESC vs Retina (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_Retina.stemcell, 
                   'ESC vs RPE (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_RPE.stemcell, 
                   'Retina (stem cell) vs RPE (stem cell)' = test2_contrast_genes$Retina.stemcell_vs_RPE.stemcell)
upset(fromList(test2_comps),sets = rev(names(test2_comps)), keep.order = T, mainbar.y.max = 2500, sets.bar.color = '#3eb9c4', matrix.color = '#3eb9c4', main.bar.color = '#3eb9c4', set_size.angles = 45)

test2_contrast_genes <- contrast_DOWNgene_lists(big_six[[2]])
test2_comps <- list('ESC vs Retina (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_Retina.stemcell, 
                   'ESC vs RPE (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_RPE.stemcell, 
                   'Retina (stem cell) vs RPE (stem cell)' = test2_contrast_genes$Retina.stemcell_vs_RPE.stemcell)
upset(fromList(test2_comps), sets = rev(names(test2_comps)),keep.order = T, mainbar.y.max = 2500, sets.bar.color = '#ef6d62', matrix.color = '#ef6d62', main.bar.color = '#ef6d62', set_size.angles = 45)
```
GO enrichment
```{r, message = FALSE}
testB_go_all_sets <- all_go_tester(big_six[[2]],'Test B')

# #stem cell rpe >> stem cell retina
# test2_contrast_genes <- contrast_UPgene_lists(big_six[[2]])
# sets <- set_maker(test2_contrast_genes$ESC.stemcell_vs_Retina.stemcell,
#                   test2_contrast_genes$ESC.stemcell_vs_RPE.stemcell,
#                   test2_contrast_genes$Retina.stemcell_vs_RPE.stemcell)
# length(sets$c)
# retina.stem_vs_rpe.stem_up <- GO_enrichment(sets$c, background_genes ,'BP')
# nrow(retina.stem_vs_rpe.stem_up %>% filter(as.numeric(`P value (FDR)`)<0.05))
# go_printer(retina.stem_vs_rpe.stem_up, 8, 'Stem Cell Retina > Stem Cell RPE')
# 
#   
# #stem cell rpe << stem cell retina
# test2_contrast_genes <- contrast_DOWNgene_lists(big_six[[2]])
# sets <- set_maker(test2_contrast_genes$ESC.stemcell_vs_Retina.stemcell,
#                   test2_contrast_genes$ESC.stemcell_vs_RPE.stemcell,
#                   test2_contrast_genes$Retina.stemcell_vs_RPE.stemcell)
# length(sets$c)
# retina.stem_vs_rpe.stem_down <- GO_enrichment(sets$c, background_genes ,'BP')
# nrow(retina.stem_vs_rpe.stem_down %>% filter(as.numeric(`P value (FDR)`)<0.05))
# go_printer(retina.stem_vs_rpe.stem_down, 8, 'Stem Cell Retina < Stem Cell RPE')
# 
# #stem cell rpe << ESC
# test2_contrast_genes <- contrast_UPgene_lists(big_six[[2]])
# sets <- set_maker(test2_contrast_genes$ESC.stemcell_vs_Retina.stemcell,
#                   test2_contrast_genes$ESC.stemcell_vs_RPE.stemcell,
#                   test2_contrast_genes$Retina.stemcell_vs_RPE.stemcell)
# length(sets$b)
# esc_vs_rpe.stem_up <- GO_enrichment(sets$b, background_genes ,'BP')
# nrow(esc_vs_rpe.stem_up %>% filter(as.numeric(`P value (FDR)`)<0.05))
# go_printer(esc_vs_rpe.stem_up, 8, 'ESC > Stem Cell RPE')
# 
#   
# #stem cell rpe >> ESC
# test2_contrast_genes <- contrast_DOWNgene_lists(big_six[[2]])
# sets <- set_maker(test2_contrast_genes$ESC.stemcell_vs_Retina.stemcell,
#                   test2_contrast_genes$ESC.stemcell_vs_RPE.stemcell,
#                   test2_contrast_genes$Retina.stemcell_vs_RPE.stemcell)
# length(sets$b)
# esc_vs_rpe.stem_down <- GO_enrichment(sets$b, background_genes ,'BP')
# nrow(esc_vs_rpe.stem_down %>% filter(as.numeric(`P value (FDR)`)<0.05))
# go_printer(esc_vs_rpe.stem_down, 8, 'ESC < Stem Cell RPE')
```
# 3. Adult RPE vs Fetal RPE vs Cell Line RPE
 RPE (stem cell) vs RPE (fetal) - coef 1
	RPE (stem cell) vs RPE (adult) - coef 2
	RPE (fetal) vs RPE (adult) - (coef 3)
```{r, message = FALSE}

test3_contrast_genes <- contrast_UPgene_lists(big_six[[3]])
test3_comps <- list('RPE (stem cell) vs RPE (fetal)' = test3_contrast_genes$RPE.stemcell_vs_RPE.fetal, 
                   'RPE (stem cell) vs RPE (adult)' = test3_contrast_genes$RPE.stemcell_vs_RPE.adult, 
                   'RPE (fetal) vs RPE (adult)' = test3_contrast_genes$RPE.fetal_vs_RPE.adult)
upset(fromList(test3_comps),sets = rev(names(test3_comps)), keep.order = T, mainbar.y.max = 3000, sets.bar.color = '#3eb9c4', matrix.color = '#3eb9c4', main.bar.color = '#3eb9c4', set_size.angles = 45)

test3_contrast_genes <- contrast_DOWNgene_lists(big_six[[3]])
test3_comps <- list('RPE (stem cell) vs RPE (fetal)' = test3_contrast_genes$RPE.stemcell_vs_RPE.fetal, 
                   'RPE (stem cell) vs RPE (adult)' = test3_contrast_genes$RPE.stemcell_vs_RPE.adult, 
                   'RPE (fetal) vs RPE (adult)' = test3_contrast_genes$RPE.fetal_vs_RPE.adult)
upset(fromList(test3_comps), sets = rev(names(test3_comps)),keep.order = T, mainbar.y.max = 3000, sets.bar.color = '#ef6d62', matrix.color = '#ef6d62', main.bar.color = '#ef6d62', set_size.angles = 45)
```

## GO terms
```{r}
testC_go_all_sets <- all_go_tester(big_six[[3]],'Test C')

go_printer(testC_go_all_sets %>% filter(Test=='Test C',Set=='b',Direction=='Up',as.numeric(`P value (FDR)`)<0.05) %>%  dplyr::select(`GO BP ID`:Term),15, 'Test C - Set B Down')
```

# 4. immortalized RPE vs Stem Cell Line RPE
```{r, messager = FALSE}
colnames(big_six[[4]])
test4_contrast_genes_up <-contrast_UPgene_lists(big_six[[4]])
test4_up_go <- GO_enrichment(test4_contrast_genes_up, background_genes ,'BP')
test4_up_go <- test4_up_go %>% mutate(Test='Test D', Set='a',Direction='Up',Contrasts=colnames(big_six[[4]]))
go_printer(test4_up_go,8, 'Stem Cell RPE < Immortalized Cell Line RPE')

test4_contrast_genes_down <-contrast_DOWNgene_lists(big_six[[4]])
test4_down_go <- GO_enrichment(test4_contrast_genes_down, background_genes ,'BP')
test4_down_go <- test4_down_go %>% mutate(Test='Test D', Set='b',Direction='Down',Contrasts=colnames(big_six[[4]]))
go_printer(test4_down_go,8, 'Stem Cell RPE > Immortalized Cell Line RPE')
```
# 5. Adult Retina vs Stem Cell Line Retina
```{r, message =  FALSE}
colnames(big_six[[5]])
test5_contrast_genes_up <-contrast_UPgene_lists(big_six[[5]])
test5_contrast_genes_down <-contrast_DOWNgene_lists(big_six[[5]])


test5_up_go <- GO_enrichment(test5_contrast_genes_up$Retina.adult_vs_Retina.stemcell, background_genes ,'BP')
test5_up_go <- test5_up_go %>% mutate(Test='Test E', Set='a',Direction='Up',Contrasts=colnames(big_six[[5]]))

#go_printer(test5_up_go,8, 'Stem Cell Retina > Adult Retina')

test5_down_go <- GO_enrichment(test5_contrast_genes_down$Retina.adult_vs_Retina.stemcell, background_genes ,'BP')
test5_down_go <- test5_down_go %>% mutate(Test='Test E', Set='b',Direction='Down',Contrasts=colnames(big_six[[5]]))
#go_printer(test5_down_go,8, 'Stem Cell Retina < Adult Retina')
```
# 6. Adult Cornea vs Fetal Cornea vs Cell Line Cornea
```{r, message= FALSE}
colnames(big_six[[6]])

test6_contrast_genes <- contrast_UPgene_lists(big_six[[6]])
test6_comps <- list('Cornea vs Cornea (fetal)' = test6_contrast_genes$Cornea.adult_vs_Cornea.fetal,
                   'Cornea vs Cornea (cell line)' = test6_contrast_genes$Cornea.adult_vs_Cornea.immortalizedcell, 
                   'Cornea (fetal) vs Cornea (cell line)' = test6_contrast_genes$Cornea.fetal_vs_Cornea.immortalizedcell)
upset(fromList(test6_comps),sets = rev(names(test6_comps)), keep.order = T, mainbar.y.max = 1750, sets.bar.color = '#3eb9c4', matrix.color = '#3eb9c4', main.bar.color = '#3eb9c4', set_size.angles = 45)

test6_contrast_genes <- contrast_DOWNgene_lists(big_six[[6]])
test6_comps <- list('Cornea vs Cornea (fetal)' = test6_contrast_genes$Cornea.adult_vs_Cornea.fetal,
                   'Cornea vs Cornea (cell line)' = test6_contrast_genes$Cornea.adult_vs_Cornea.immortalizedcell, 
                   'Cornea (fetal) vs Cornea (cell line)' = test6_contrast_genes$Cornea.fetal_vs_Cornea.immortalizedcell)
upset(fromList(test6_comps), sets = rev(names(test6_comps)),keep.order = T, mainbar.y.max = 1750, sets.bar.color = '#ef6d62', matrix.color = '#ef6d62', main.bar.color = '#ef6d62', set_size.angles = 45)
```

## GO
```{r, message = FALSE}
testF_go_all_sets <- all_go_tester(big_six[[6]],'Test F')
```

# How to find what genes are the GO:ID
```{r, message = FALSE}
go_associated_genes <- GO_term_finder(retina_rpe_GO_genes_up,'GO:0050953')
topTable(big_six[[1]],number=30000) %>% rownames_to_column('Gene') %>% filter(Gene %in% go_associated_genes)
```

# Save GO term enrichment searches
```{r, message = FALSE}
go_enrichment <- bind_rows(testA_go_all_sets,
                       testB_go_all_sets,
                       testC_go_all_sets,
                       test4_up_go,
                       test4_down_go,
                       test5_up_go,
                       test5_down_go,
                       testF_go_all_sets)
#save(go_enrichment, file='~/git/unified_gene_expression/data/go_enrichment.Rdata')
```

# Print out GO results as csv
```{r, message = FALSE}
out_csv = data.frame()
for (i in names(go_enrichment)) {
  out <- go_enrichment[[i]] %>% mutate(Test = gsub('\\.|_',' ', i)) %>% head(n=15)
  out_csv <- rbind(out_csv, out)
}
write.csv(out_csv, file='~/Dropbox/Work/NEI/PROJECTS/mcgaughey/eyeIntegration/supplemental_table_s3.csv')

out_csv = data.frame()
for (i in names(go_enrichment)) {
  sig_results = go_enrichment[[i]] %>% filter(as.numeric(`P value`)<0.01) %>% nrow()
  results_to_keep = max(sig_results, 10)
  out <- go_enrichment[[i]] %>% mutate(Test = gsub('\\.|_',' ', i)) %>% head(n=results_to_keep)
  out_csv <- rbind(out_csv, out)
}

#write.csv(out_csv, file='~/Dropbox/Work/NEI/PROJECTS/mcgaughey/eyeIntegration/supplemental_table_s4.csv')
```

RPE vs Retina adult __ VS __ RPE vs Retina stem
```{r}

## adult
test1_contrast_genes <- contrast_UPgene_lists(big_six[[1]])
sets <- set_maker(test1_contrast_genes$Cornea.adult_vs_Retina.adult,
                  test1_contrast_genes$Cornea.adult_vs_RPE.adult,
                  test1_contrast_genes$Retina.adult_vs_RPE.adult)
retina.adult_vs_rpe.adult_up_genes <- sets$c

test1_contrast_genes <- contrast_DOWNgene_lists(big_six[[1]])
sets <- set_maker(test1_contrast_genes$Cornea.adult_vs_Retina.adult,
                  test1_contrast_genes$Cornea.adult_vs_RPE.adult,
                  test1_contrast_genes$Retina.adult_vs_RPE.adult)
retina.adult_vs_rpe.adult_down_genes <- sets$c

## stem cells
test2_contrast_genes <- contrast_UPgene_lists(big_six[[2]])
sets <- set_maker(test2_contrast_genes$ESC.stemcell_vs_Retina.stemcell,
                  test2_contrast_genes$ESC.stemcell_vs_RPE.stemcell,
                  test2_contrast_genes$Retina.stemcell_vs_RPE.stemcell)
retina.stem_vs_rpe.stem_up_genes <- sets$c

test2_contrast_genes <- contrast_DOWNgene_lists(big_six[[2]])
sets <- set_maker(test2_contrast_genes$ESC.stemcell_vs_Retina.stemcell,
                  test2_contrast_genes$ESC.stemcell_vs_RPE.stemcell,
                  test2_contrast_genes$Retina.stemcell_vs_RPE.stemcell)
retina.stem_vs_rpe.stem_down_genes <- sets$c



## set operations
length(retina.adult_vs_rpe.adult_up_genes)
length(retina.adult_vs_rpe.adult_down_genes)
length(retina.stem_vs_rpe.stem_up_genes)
length(retina.stem_vs_rpe.stem_down_genes)
length(intersect(retina.adult_vs_rpe.adult_up_genes, retina.stem_vs_rpe.stem_up_genes))
length(intersect(retina.adult_vs_rpe.adult_down_genes, retina.stem_vs_rpe.stem_down_genes))

# let's find genes that are up in retina stem cells (relative to rpe stem) but NOT up
```