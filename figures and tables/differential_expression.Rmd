---
title: "Figure 3"
output:
  html_notebook: default
  word_document: default
---
```{r,message = FALSE}
library(broom)
library(UpSetR)
library(tidyverse)
library(limma)
library(DT)
library(ReporteRs)
load('~/git/unified_gene_expression/data/big_six_DE.Rdata')
load('~/git/unified_gene_expression/data/limma_voom_DE_all_by_all.Rdata')
source('~/git/unified_gene_expression/scripts/GO_enrichment.R')
source('~/git/unified_gene_expression/scripts/GO_term_finder.R')
# for GO enrichement
background_genes <- topTable(big_six[[1]], number=30000) %>% rownames_to_column('Gene') %>% dplyr::select(Gene)
options("ReporteRs-fontsize"=8, "ReporteRs-default-font"="Monaco")
```

Overall counts up and down for the six tests
```{r, message = FALSE}
test1_summary <- summary(decideTests(big_six[[1]], lfc = 1, p.value = 0.05, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '1')
test2_summary <- summary(decideTests(big_six[[2]], lfc = 1, p.value = 0.05, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '2')
test3_summary <- summary(decideTests(big_six[[3]], lfc = 1, p.value = 0.05, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '3')
test4_summary <- summary(decideTests(big_six[[4]], lfc = 1, p.value = 0.05, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '4')
test5_summary <- summary(decideTests(big_six[[5]], lfc = 1, p.value = 0.05, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '5')
test6_summary <- summary(decideTests(big_six[[6]], lfc = 1, p.value = 0.05, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '6')

test_summaries <- rbind(test1_summary,test2_summary,test3_summary,test4_summary,test5_summary,test6_summary)
colnames(test_summaries) <- c('LogFC','Comparison','Count','Comparison Set')

test_summaries <- test_summaries %>% 
  filter(LogFC!=0) %>% 
  dplyr::select(-`Comparison Set`) %>% 
  spread(Comparison, Count) %>% t() %>% 
  data.frame() %>% 
  rownames_to_column('Comparisons') %>% 
  dplyr::slice(-1) %>% 
  separate(Comparisons, c('Comparison','Base'), sep='_vs_') %>% 
  mutate(Comparison=gsub('\\.',' (',Comparison), Comparison=gsub('$',')', Comparison), Comparison=gsub('cell',' cell', Comparison)) %>% 
  mutate(Base=gsub('\\.',' (',Base), Base=gsub('$',')', Base), Base=gsub('cell',' cell', Base))

colnames(test_summaries)<- c('Comparison','Reference', 'LogFC < -1', 'LogFC > 1')
```

Format table 
http://davidgohel.github.io/ReporteRs/articles/flextable_examples.html
```{r}
no_border = borderProperties( width = 0 )
big_border = borderProperties( width = 2 )
std_border = borderProperties( width = 1 )
    
the_table <- test_summaries %>% 
  mutate(Test=c('A','A','A','B','B','B','C','C','C','D','E','F','F','F')) %>% 
  mutate(Comparison = paste(Comparison, Reference, sep = ' vs ')) %>% 
  dplyr::select(Test, Comparison, `LogFC < -1`, `LogFC > 1`) 

flex_table <- the_table %>% FlexTable(body.cell.props = cellProperties( padding = 2 ), 
                        header.par.props = parProperties(text.align = "center" ), 
                        body.par.props = parProperties(text.align = 'left'),
                        header.columns = FALSE) %>% 
  spanFlexTableRows(.,j="Test",runs=as.character(the_table$Test)) %>%
  addHeaderRow(value = c("", "Log Fold Change"), colspan = c( 2, 2 ) ) %>% 
  addHeaderRow(value = c('Test', 'Comparison', '< -1', '> 1')) %>% 
  setFlexTableBorders(footer = TRUE,
                      inner.vertical = no_border, inner.horizontal = std_border,
                      outer.vertical = no_border, outer.horizontal = big_border )

flex_table[2,1:2, to="header", side = "top"] = no_border
flex_table
#doc = docx()
#doc = addFlexTable(doc, flex_table)
#writeDoc(doc,file='~/Desktop/table class.docx')
```

Function to pull different sets out
```{r, message = FALSE}
set_maker <- function(a,b,c){
  a_set <- setdiff(a,c(b,c))
  b_set <- setdiff(b,c(a,c))
  c_set <- setdiff(c,c(a,b))
  abc <- Reduce(intersect,list(a,b,c))
  ab <- setdiff(intersect(a,b),c)
  ac <- setdiff(intersect(a,c),b)
  bc <- setdiff(intersect(b,c),a)
  list(a=a_set,b=b_set,c=c_set,ab=ab,ac=ac,bc=bc,abc=abc)
}
```

Function to return gene list that are abs(logFC) > 1 and adj.P.Val < 0.05 for the different contrasts
```{r, messag= FALSE}
# all sig
contrast_gene_lists <- function(limma_data){
  vector_of_comparisons <- colnames(limma_data)
  print(vector_of_comparisons)
  out_list <- list()
  for (i in 1:length(vector_of_comparisons)){
    stats <-  topTable(limma_data, coef=i, number = 30000, adjust.method = 'fdr', p.value = 0.05)
    if(nrow(stats)==0){
      out_list[vector_of_comparisons[i]] <- list('')
      next}
    stats_cut_down <- stats[abs(stats[,'logFC']) > 1,]
    out_list[vector_of_comparisons[i]] <- list(row.names(stats_cut_down))
    }
  out_list
}
# just up vs 'control' (left side of contrast)
contrast_UPgene_lists <- function(limma_data){
  vector_of_comparisons <- colnames(limma_data)
  out_list <- list()
  for (i in 1:length(vector_of_comparisons)){
    stats <-  topTable(limma_data, coef=i, number = 30000, adjust.method = 'fdr', p.value = 0.05)
    if(nrow(stats)==0){
      out_list[vector_of_comparisons[i]] <- list('')
      next}
    stats_cut_down <- stats[stats[,'logFC'] > 1,]
    out_list[vector_of_comparisons[i]] <- list(row.names(stats_cut_down))
    }
  out_list
}
# just down
contrast_DOWNgene_lists <- function(limma_data){
  vector_of_comparisons <- colnames(limma_data)
  out_list <- list()
  for (i in 1:length(vector_of_comparisons)){
    stats <-  topTable(limma_data, coef=i, number = 30000, adjust.method = 'fdr', p.value = 0.05)
    if(nrow(stats)==0){
      out_list[vector_of_comparisons[i]] <- list('')
      next}
    stats_cut_down <- stats[stats[,'logFC'] < -1,]
    out_list[vector_of_comparisons[i]] <- list(row.names(stats_cut_down))
    }
  out_list
}
```


```{r}
#GO printer
go_printer <- function(go_frame, num_to_print, title){
  out <- go_frame %>% 
    head(n=num_to_print) %>% FlexTable(body.cell.props = cellProperties( padding = 2 ), 
                        header.par.props = parProperties(text.align = "left" ), 
                        body.par.props = parProperties(text.align = 'left'), header.columns = FALSE) %>%
    addHeaderRow(value = c(title), colspan = c(8), par.properties = parProperties(text.align='left')) %>% 
    addHeaderRow(value = colnames(go_frame)) %>% 
    setFlexTableWidths(widths = c(1, 1.2, 1.2, 1, 0.5, 0.7, 0.7, 6) )  %>% 
    setFlexTableBorders(inner.vertical = no_border, inner.horizontal = no_border,
                      outer.vertical = no_border, outer.horizontal = big_border )
  print(out)
}
```
Six DE tests:

1. Cornea vs Retina vs RPE (all adult)
2. ESC vs RPE vs Retina (all Stem cell lines, non immortalized)
3. Adult RPE vs Fetal RPE vs Cell Line RPE
4. immortalized RPE vs Stem Cell Line RPE
5. Adult Retina vs Stem Cell Line Retina
6. Adult Cornea vs Fetal Cornea vs Cell Line Cornea


# 1. Cornea vs Retina vs RPE (all adult)
```{r, message = FALSE, fig.width=2, fig.height=1.5}

colnames(big_six[[1]])

test1_contrast_genes <- contrast_gene_lists(big_six[[1]])
test1_comps <- list('Cornea vs Retina' = test1_contrast_genes$Cornea.adult_vs_Retina.adult, 
                   'Cornea vs RPE' = test1_contrast_genes$Cornea.adult_vs_RPE.adult, 
                   'Retina vs RPE' = test1_contrast_genes$Retina.adult_vs_RPE.adult)
upset(fromList(test1_comps),mainbar.y.max = 3250, keep.order = T)


test1_contrast_genes <- contrast_UPgene_lists(big_six[[1]])
test1_comps <- list('Cornea vs Retina' = test1_contrast_genes$Cornea.adult_vs_Retina.adult, 
                   'Cornea vs RPE' = test1_contrast_genes$Cornea.adult_vs_RPE.adult, 
                   'Retina vs RPE' = test1_contrast_genes$Retina.adult_vs_RPE.adult)
upset(fromList(test1_comps),mainbar.y.max = 2000, keep.order = T, sets.bar.color = '#3eb9c4', matrix.color = '#3eb9c4', main.bar.color = '#3eb9c4')


test1_contrast_genes <- contrast_DOWNgene_lists(big_six[[1]])
test1_comps <- list('Cornea vs Retina' = test1_contrast_genes$Cornea.adult_vs_Retina.adult, 
                   'Cornea vs RPE' = test1_contrast_genes$Cornea.adult_vs_RPE.adult, 
                   'Retina vs RPE' = test1_contrast_genes$Retina.adult_vs_RPE.adult)
upset(fromList(test1_comps),mainbar.y.max = 2000, keep.order = T, sets.bar.color = '#ef6d62', matrix.color = '#ef6d62', main.bar.color = '#ef6d62')
```

GO enrichment. Retina against RPE
```{r, message = FALSE}
# Retina vs RPE unique, up (RPE >> retina for gene expression)
test1_contrast_genes <- contrast_UPgene_lists(big_six[[1]])
sets <- set_maker(test1_contrast_genes$Cornea.adult_vs_Retina.adult,
                  test1_contrast_genes$Cornea.adult_vs_RPE.adult,
                  test1_contrast_genes$Retina.adult_vs_RPE.adult)
retina_rpe_GO_up <- GO_enrichment(sets$c, background_genes ,'BP')
go_printer(retina_rpe_GO_up,20,'RPE > Retina')

# Retina vs RPE unique, down (retina >> RPE)
test1_contrast_genes <- contrast_DOWNgene_lists(big_six[[1]])
sets <- set_maker(test1_contrast_genes$Cornea.adult_vs_Retina.adult,
                  test1_contrast_genes$Cornea.adult_vs_RPE.adult,
                  test1_contrast_genes$Retina.adult_vs_RPE.adult)
retina_rpe_GO_down <- GO_enrichment(sets$c, background_genes ,'BP')
go_printer(retina_rpe_GO_down,20,'RPE < Retina')
```

Go enrichment. Cornea against Retina/RPE
```{r, message = FALSE}
# cornea vs RPE and retina (RPE and retina >> cornea)
test1_contrast_genes <- contrast_UPgene_lists(big_six[[1]])
sets <- set_maker(test1_contrast_genes$Cornea.adult_vs_Retina.adult,
                  test1_contrast_genes$Cornea.adult_vs_RPE.adult,
                  test1_contrast_genes$Retina.adult_vs_RPE.adult)
length(sets$ab)
cornea_vs_retina_rpe_GO_up <- GO_enrichment(sets$ab, background_genes ,'BP')
go_printer(cornea_vs_retina_rpe_GO_up,10, 'RPE and Retina > Cornea')

  
# cornea vs RPE and retina (RPE and retina << cornea)
test1_contrast_genes <- contrast_DOWNgene_lists(big_six[[1]])
sets <- set_maker(test1_contrast_genes$Cornea.adult_vs_Retina.adult,
                  test1_contrast_genes$Cornea.adult_vs_RPE.adult,
                  test1_contrast_genes$Retina.adult_vs_RPE.adult)
length(sets$ab)
cornea_vs_retina_rpe_GO_down <- GO_enrichment(sets$ab, background_genes ,'BP')
go_printer(cornea_vs_retina_rpe_GO_down,10, 'RPE and Retina < Cornea')

```

# 2. ESC vs RPE vs Retina (all Stem cell lines, non immortalized)
```{r, message = FALSE, fig.width=2, fig.height=1.5}
colnames(big_six[[2]])
test2_contrast_genes <- contrast_gene_lists(big_six[[2]])
test2_comps <- list('ESC vs Retina (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_Retina.stemcell, 
                   'ESC vs RPE (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_RPE.stemcell, 
                   'Retina (stem cell) vs RPE (stem cell)' = test2_contrast_genes$Retina.stemcell_vs_RPE.stemcell)
upset(fromList(test2_comps), keep.order = T, mainbar.y.max = 3000)

test2_contrast_genes <- contrast_UPgene_lists(big_six[[2]])
test2_comps <- list('ESC vs Retina (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_Retina.stemcell, 
                   'ESC vs RPE (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_RPE.stemcell, 
                   'Retina (stem cell) vs RPE (stem cell)' = test2_contrast_genes$Retina.stemcell_vs_RPE.stemcell)
upset(fromList(test2_comps), keep.order = T, mainbar.y.max = 1700, sets.bar.color = '#3eb9c4', matrix.color = '#3eb9c4', main.bar.color = '#3eb9c4')

test2_contrast_genes <- contrast_DOWNgene_lists(big_six[[2]])
test2_comps <- list('ESC vs Retina (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_Retina.stemcell, 
                   'ESC vs RPE (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_RPE.stemcell, 
                   'Retina (stem cell) vs RPE (stem cell)' = test2_contrast_genes$Retina.stemcell_vs_RPE.stemcell)
upset(fromList(test2_comps), keep.order = T, mainbar.y.max = 1700, sets.bar.color = '#ef6d62', matrix.color = '#ef6d62', main.bar.color = '#ef6d62')
```

# 3. Adult RPE vs Fetal RPE vs Cell Line RPE
No significant genes in the  'RPE (stem cell) vs RPE (fetal)' comparison.
Quite a few (471 and 371) for	RPE (stem cell) vs RPE (adult)	471	371	(coef 2)
Nearly none (12 and 20) for 	RPE (fetal) vs RPE (adult) (coef 3)
```{r, message = FALSE}
colnames(big_six[[3]])

test3_contrast_genes <-contrast_UPgene_lists(big_six[[3]])
coef2_up_unique <- setdiff(test3_contrast_genes$RPE.stemcell_vs_RPE.adult, test3_contrast_genes$RPE.fetal_vs_RPE.adult)
coef2_up_GO <- GO_enrichment(coef2_up_unique, background_genes ,'BP')
go_printer(coef2_up_GO %>% filter(`Expected Count` > 0.8),10, 'Adult RPE > Stem Cell RPE')

#coef3_up_unique <- setdiff(test3_contrast_genes$RPE.fetal_vs_RPE.adult, test3_contrast_genes$RPE.stemcell_vs_RPE.adult)
#coef3_up_GO <- GO_enrichment(coef3_up_unique, background_genes ,'BP')
#coef3_up_GO %>% filter(`Expected Count` > 0.8) %>%  DT::datatable(options = list(pageLength = 20)) 

test3_contrast_genes <-contrast_DOWNgene_lists(big_six[[3]])
coef2_down_unique <- setdiff(test3_contrast_genes$RPE.stemcell_vs_RPE.adult, test3_contrast_genes$RPE.fetal_vs_RPE.adult)
coef2_down_GO <- GO_enrichment(coef2_down_unique, background_genes ,'BP')
go_printer(coef2_down_GO %>% filter(`Expected Count` > 0.8),10, 'Adult RPE < Stem Cell RPE')
#coef3_down_unique <- setdiff(test3_contrast_genes$RPE.fetal_vs_RPE.adult, test3_contrast_genes$RPE.stemcell_vs_RPE.adult)
#coef3_down_GO <- GO_enrichment(coef3_down_unique, background_genes ,'BP')
#coef3_up_GO %>% filter(`Expected Count` > 0.8) %>%  DT::datatable(options = list(pageLength = 20)) 

```
# 4. immortalized RPE vs Stem Cell Line RPE
```{r, messager = FALSE}
colnames(big_six[[4]])
test4_contrast_genes_up <-contrast_UPgene_lists(big_six[[4]])
test4_up_go <- GO_enrichment(test4_contrast_genes_up, background_genes ,'BP')
go_printer(test4_up_go,10, 'Stem Cell RPE < Immortalized Cell Line RPE')

test4_contrast_genes_down <-contrast_DOWNgene_lists(big_six[[4]])
test4_down_go <- GO_enrichment(test4_contrast_genes_down, background_genes ,'BP')
go_printer(test4_down_go,10, 'Stem Cell RPE > Immortalized Cell Line RPE')
```
# 5. Adult Retina vs Stem Cell Line Retina
```{r, message =  FALSE}
colnames(big_six[[5]])
test5_contrast_genes_up <-contrast_UPgene_lists(big_six[[5]])
test5_contrast_genes_down <-contrast_DOWNgene_lists(big_six[[5]])

test5_up_go <- GO_enrichment(test5_contrast_genes_up$Retina.adult_vs_Retina.stemcell, background_genes ,'BP')
go_printer(test5_up_go,10, 'Stem Cell Retina > Adult Retina')

test5_down_go <- GO_enrichment(test5_contrast_genes_down$Retina.adult_vs_Retina.stemcell, background_genes ,'BP')
go_printer(test5_down_go,10, 'Stem Cell Retina < Adult Retina')
```
# 6. Adult Cornea vs Fetal Cornea vs Cell Line Cornea
```{r, message= FALSE}
topTable(big_six[[6]],coef=1, p.value = 0.05)
```


# How to find what genes are the GO:ID
```{r, message = FALSE}
go_associated_genes <- GO_term_finder(test5_contrast_genes_up,'GO:0007399') %>% head()
topTable(big_six[[5]],number=30000) %>% rownames_to_column('Gene') %>% filter(Gene %in% go_associated_genes)
```

