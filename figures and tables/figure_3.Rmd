---
title: "Figure 3"
output: html_notebook
---
```{r,message = FALSE}
library(broom)
library(UpSetR)
library(tidyverse)
library(limma)
load('~/git/unified_gene_expression/data/big_six_DE.Rdata')
load('~/git/unified_gene_expression/data/limma_voom_DE_all_by_all.Rdata')
source('~/git/unified_gene_expression/scripts/GO_enrichment.R')

# for GO enrichement
background_genes <- topTable(big_six[[1]], number=30000) %>% rownames_to_column('Gene') %>% dplyr::select(Gene)
```

Overall counts up and down for the six tests
```{r, message = FALSE}
test1_summary <- summary(decideTests(big_six[[1]], lfc = 1, p.value = 0.05, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '1')
test2_summary <- summary(decideTests(big_six[[2]], lfc = 1, p.value = 0.05, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '2')
test3_summary <- summary(decideTests(big_six[[3]], lfc = 1, p.value = 0.05, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '3')
test4_summary <- summary(decideTests(big_six[[4]], lfc = 1, p.value = 0.05, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '4')
test5_summary <- summary(decideTests(big_six[[5]], lfc = 1, p.value = 0.05, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '5')
test6_summary <- summary(decideTests(big_six[[6]], lfc = 1, p.value = 0.05, adjust.method = 'fdr')) %>% tidy() %>% mutate(Comparison = '6')

test_summaries <- rbind(test1_summary,test2_summary,test3_summary,test4_summary,test5_summary,test6_summary)
colnames(test_summaries) <- c('LogFC','Comparison','Count','Comparison Set')

test_summaries <- test_summaries %>% 
  filter(LogFC!=0) %>% 
  dplyr::select(-`Comparison Set`) %>% 
  spread(Comparison, Count) %>% t() %>% 
  data.frame() %>% 
  rownames_to_column('Comparisons') %>% 
  dplyr::slice(-1) %>% 
  separate(Comparisons, c('Comparison','Base'), sep='_vs_') %>% 
  mutate(Comparison=gsub('\\.',' (',Comparison), Comparison=gsub('$',')', Comparison), Comparison=gsub('cell',' cell', Comparison)) %>% 
  mutate(Base=gsub('\\.',' (',Base), Base=gsub('$',')', Base), Base=gsub('cell',' cell', Base))

colnames(test_summaries)<- c('Comparison','Reference', 'LogFC < -1', 'LogFC > 1')

test_summaries %>% mutate(`Test #`=c(1,1,1,2,2,2,3,3,3,4,5,6,6,6)) %>% mutate(Comparison = paste(Comparison, Reference, sep = ' vs ')) %>% dplyr::select(`Test #`, Comparison, `LogFC < -1`, `LogFC > 1`)
```

Function to pull different sets out
```{r, message = FALSE}
set_maker <- function(a,b,c){
  a_set <- setdiff(a,c(b,c))
  b_set <- setdiff(b,c(a,c))
  c_set <- setdiff(c,c(a,b))
  abc <- Reduce(intersect,list(a,b,c))
  ab <- setdiff(intersect(a,b),c)
  ac <- setdiff(intersect(a,c),b)
  bc <- setdiff(intersect(b,c),a)
  list(a=a_set,b=b_set,c=c_set,ab=ab,ac=ac,bc=bc,abc=abc)
}
```

Function to return gene list that are abs(logFC) > 1 and adj.P.Val < 0.05 for the different contrasts
```{r, messag= FALSE}
contrast_gene_lists <- function(limma_data){
  vector_of_comparisons <- colnames(limma_data)
  print(vector_of_comparisons)
  out_list <- list()
  for (i in 1:length(vector_of_comparisons)){
    stats <-  topTable(limma_data, coef=i, number = 30000, adjust.method = 'fdr', p.value = 0.05)
    if(nrow(stats)==0){
      out_list[vector_of_comparisons[i]] <- list('')
      next}
    stats_cut_down <- stats[abs(stats[,'logFC']) > 1,]
    out_list[vector_of_comparisons[i]] <- list(row.names(stats_cut_down))
    }
  out_list
}

contrast_UPgene_lists <- function(limma_data){
  vector_of_comparisons <- colnames(limma_data)
  out_list <- list()
  for (i in 1:length(vector_of_comparisons)){
    stats <-  topTable(limma_data, coef=i, number = 30000, adjust.method = 'fdr', p.value = 0.05)
    stats_cut_down <- stats[stats[,'logFC'] > 1,]
    out_list[vector_of_comparisons[i]] <- list(row.names(stats_cut_down))
    }
  out_list
}

contrast_DOWNgene_lists <- function(limma_data){
  vector_of_comparisons <- colnames(limma_data)
  out_list <- list()
  for (i in 1:length(vector_of_comparisons)){
    stats <-  topTable(limma_data, coef=i, number = 30000, adjust.method = 'fdr', p.value = 0.05)
    stats_cut_down <- stats[stats[,'logFC'] < -1,]
    out_list[vector_of_comparisons[i]] <- list(row.names(stats_cut_down))
    }
  out_list
}
```

Six DE tests:
1. Cornea vs Retina vs RPE (all adult)
2. ESC vs RPE vs Retina (all Stem cell lines, non immortalized)
3. Adult RPE vs Fetal RPE vs Cell Line RPE
4. immortalized RPE vs Stem Cell Line RPE
5. Adult Retina vs Stem Cell Line Retina
6. Adult Cornea vs Fetal Cornea vs Cell Line Cornea

1. Cornea vs Retina vs RPE (all adult)
```{r, message = FALSE, fig.width=2, fig.height=1.5}

colnames(big_six[[1]])

test1_contrast_genes <- contrast_gene_lists(big_six[[1]])
test1_comps <- list('Cornea vs Retina' = test1_contrast_genes$Cornea.adult_vs_Retina.adult, 
                   'Cornea vs RPE' = test1_contrast_genes$Cornea.adult_vs_RPE.adult, 
                   'Retina vs RPE' = test1_contrast_genes$Retina.adult_vs_RPE.adult)
upset(fromList(test1_comps),mainbar.y.max = 3250, keep.order = T)


test1_contrast_genes <- contrast_UPgene_lists(big_six[[1]])
test1_comps <- list('Cornea vs Retina' = test1_contrast_genes$Cornea.adult_vs_Retina.adult, 
                   'Cornea vs RPE' = test1_contrast_genes$Cornea.adult_vs_RPE.adult, 
                   'Retina vs RPE' = test1_contrast_genes$Retina.adult_vs_RPE.adult)
upset(fromList(test1_comps),mainbar.y.max = 2000, keep.order = T, sets.bar.color = 'blue', matrix.color = 'blue', main.bar.color = 'blue')


test1_contrast_genes <- contrast_DOWNgene_lists(big_six[[1]])
test1_comps <- list('Cornea vs Retina' = test1_contrast_genes$Cornea.adult_vs_Retina.adult, 
                   'Cornea vs RPE' = test1_contrast_genes$Cornea.adult_vs_RPE.adult, 
                   'Retina vs RPE' = test1_contrast_genes$Retina.adult_vs_RPE.adult)
upset(fromList(test1_comps),mainbar.y.max = 2000, keep.order = T, sets.bar.color = 'red', matrix.color = 'red', main.bar.color = 'red')
```

1. GO enrichment. Retina against RPE
```{r, message = FALSE}
# Retina vs RPE unique, up (RPE >> retina for gene expression)
test1_contrast_genes <- contrast_UPgene_lists(big_six[[1]])
sets <- set_maker(test1_contrast_genes$Cornea.adult_vs_Retina.adult,
                  test1_contrast_genes$Cornea.adult_vs_RPE.adult,
                  test1_contrast_genes$Retina.adult_vs_RPE.adult)
retina_rpe_GO_up <- GO_enrichment(sets$c, background_genes ,'BP')
# Retina vs RPE unique, down (retina >> RPE)
test1_contrast_genes <- contrast_DOWNgene_lists(big_six[[1]])
sets <- set_maker(test1_contrast_genes$Cornea.adult_vs_Retina.adult,
                  test1_contrast_genes$Cornea.adult_vs_RPE.adult,
                  test1_contrast_genes$Retina.adult_vs_RPE.adult)
retina_rpe_GO_down <- GO_enrichment(sets$c, background_genes ,'BP')
```

1. Go enrichment. Cornea against Retina/RPE
```{r, message = FALSE}
# cornea vs RPE and retina (RPE and retina >> cornea)
test1_contrast_genes <- contrast_UPgene_lists(big_six[[1]])
sets <- set_maker(test1_contrast_genes$Cornea.adult_vs_Retina.adult,
                  test1_contrast_genes$Cornea.adult_vs_RPE.adult,
                  test1_contrast_genes$Retina.adult_vs_RPE.adult)
length(sets$ab)
cornea_vs_retina_rpe_GO_up <- GO_enrichment(sets$ab, background_genes ,'BP')
# cornea vs RPE and retina (RPE and retina << cornea)
test1_contrast_genes <- contrast_DOWNgene_lists(big_six[[1]])
sets <- set_maker(test1_contrast_genes$Cornea.adult_vs_Retina.adult,
                  test1_contrast_genes$Cornea.adult_vs_RPE.adult,
                  test1_contrast_genes$Retina.adult_vs_RPE.adult)
length(sets$ab)
cornea_vs_retina_rpe_GO_down <- GO_enrichment(sets$ab, background_genes ,'BP')

```

2. ESC vs RPE vs Retina (all Stem cell lines, non immortalized)
```{r, message = FALSE, fig.width=2, fig.height=1.5}
colnames(big_six[[2]])
test2_contrast_genes <- contrast_gene_lists(big_six[[2]])
test2_comps <- list('ESC vs Retina (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_Retina.stemcell, 
                   'ESC vs RPE (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_RPE.stemcell, 
                   'Retina (stem cell) vs RPE (stem cell)' = test2_contrast_genes$Retina.stemcell_vs_RPE.stemcell)
upset(fromList(test2_comps), keep.order = T, mainbar.y.max = 3000)

test2_contrast_genes <- contrast_UPgene_lists(big_six[[2]])
test2_comps <- list('ESC vs Retina (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_Retina.stemcell, 
                   'ESC vs RPE (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_RPE.stemcell, 
                   'Retina (stem cell) vs RPE (stem cell)' = test2_contrast_genes$Retina.stemcell_vs_RPE.stemcell)
upset(fromList(test2_comps), keep.order = T, mainbar.y.max = 1700, sets.bar.color = 'blue', matrix.color = 'blue', main.bar.color = 'blue')

test2_contrast_genes <- contrast_DOWNgene_lists(big_six[[2]])
test2_comps <- list('ESC vs Retina (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_Retina.stemcell, 
                   'ESC vs RPE (stem cell)' = test2_contrast_genes$ESC.stemcell_vs_RPE.stemcell, 
                   'Retina (stem cell) vs RPE (stem cell)' = test2_contrast_genes$Retina.stemcell_vs_RPE.stemcell)
upset(fromList(test2_comps), keep.order = T, mainbar.y.max = 1700, sets.bar.color = 'red', matrix.color = 'red', main.bar.color = 'red')
```

3. Adult RPE vs Fetal RPE vs Cell Line RPE
4. immortalized RPE vs Stem Cell Line RPE
5. Adult Retina vs Stem Cell Line Retina
6. Adult Cornea vs Fetal Cornea vs Cell Line Cornea


